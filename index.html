<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>Realtime graphs</title>
	<script src="socket.io.js"></script>
	<!-- <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> -->
	<script src="plotly-latest.min.js"></script>
	<link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body>
	<div class="ui">
		<div class="chart-box">
			<h2 class="chart-title">Pressure</h2>
			<div class="chart-area" id="pressure"></div>
		</div>
		<div class="chart-box">
			<h2 class="chart-title">Test</h2>
			<div class="chart-area" id="tester"></div>
		</div>
		<div class="chart-box">
			<h2 class="chart-title">Temperature</h2>
			<div class="chart-area" id="temp"></div>
		</div>
		<div class="chart-box">
			<h2 class="chart-title">PPG</h2>
			<div class="chart-area" id="ppg"></div>
		</div>
	</div>


	<script>
		const socket = io('http://localhost:9000');

		// create a chart
		PRESR = document.getElementById('pressure');
		Plotly.newPlot(PRESR, [{
			x: [],
			y: [],
			mode: 'lines',
			line: { color: '#80CAF6' }
		}], {
			margin: { t: 0 }
		});

		TEMP = document.getElementById('temp');
		Plotly.newPlot(TEMP, [{
			x: [],
			y: [],
			mode: 'lines',
			line: { color: '#80CAF6' }
		}], {
			margin: { t: 0 }
		});

		TESTER = document.getElementById('tester');
		Plotly.newPlot(TESTER, [{
			x: [],
			y: [],
			mode: 'lines',
			line: { color: '#CA80F6' }
		}], {
			margin: { t: 0 }
		});

		var cnt = 0;
		// socket io messages draw charts
		socket.on("server", (message) => {
			// console.log(message);
			cnt = cnt + 1;
			var graph;
			for (var key of Object.keys(message.updatedFields)) {
				// console.log(key, key.substring(0, 4));
				graph = TESTER;
				if (key.substring(0, 4) == "Pres") {
					graph = PRESR;
				}
				else if (key.substring(0, 4) == "Temp") {
					graph = TEMP;
				}
				else {
					graph = TESTER;
				}

				var update = {
					x: [[cnt]], // for time stamps switch to [[message.updatedFields[key].time_stamp]],
					y: [[message.updatedFields[key].value]]
				}
				var olderTime = Math.max(0, cnt - 50);
				var futureTime = Math.max(cnt, 50);

				var minuteView = {
					xaxis: {
						type: 'value',
						range: [olderTime, futureTime]
					}
				};
				Plotly.relayout(graph, minuteView);
				Plotly.extendTraces(graph, update, [0])
			}
		});

		// testing function for realtime graphs
		function rand() {
			return Math.random();
		}
		var interval = setInterval(function () {
			var update = {
				x: [[cnt]],
				y: [[rand()]]
			}

			var olderTime = Math.max(0, cnt - 10);
			var futureTime = Math.max(cnt, 10);

			var minuteView = {
				xaxis: {
					type: 'value',
					range: [olderTime, futureTime]
				}
			};

			Plotly.relayout(TESTER, minuteView);
			Plotly.extendTraces(TESTER, update, [0])

			if (++cnt === 100) clearInterval(interval);
		}, 10);

	</script>

</body>

</html>